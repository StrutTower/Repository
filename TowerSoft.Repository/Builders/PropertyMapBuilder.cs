using System;
using TowerSoft.Repository.Maps;

namespace TowerSoft.Repository.Builders {
    /// <summary>
    /// Fluent map builder used in the EntityMap class
    /// </summary>
    public partial class PropertyMapBuilder : IEquatable<PropertyMapBuilder> {
        private string PropertyName { get; }
        private string FunctionName { get; set; }
        private bool IsAutonumber { get; set; }
        private bool IsPrimaryKey { get; set; }
        private bool IsFilemanDateMap { get; set; }
        private bool IsHorologDateMap { get; set; }

        /// <summary>
        /// PropertyMapBuilder constructor
        /// </summary>
        /// <param name="propertyName"></param>
        public PropertyMapBuilder(string propertyName) {
            PropertyName = propertyName;
        }

        /// <summary>
        /// Maps the property to a column name
        /// </summary>
        /// <param name="columnName">Column name in the database</param>
        /// <returns></returns>
        public IMap To(string columnName) {
            return GetReturnMap(columnName);
        }

        /// <summary>
        /// Maps the property to a column with the same name
        /// </summary>
        /// <returns></returns>
        public IMap ToSameName() {
            return GetReturnMap(null);
        }

        /// <summary>
        /// Marks the property as not mapped. Use this to override a map generated by the auto mapping option.
        /// </summary>
        /// <returns></returns>
        public IMap NotMapped() {
            return new Map(PropertyName, null);
        }

        /// <summary>
        /// Marks the map as an autonumber map. Use this for primary keys that auto increment
        /// </summary>
        /// <returns></returns>
        public PropertyMapBuilder AsAutonumber() {
            IsAutonumber = true;
            return this;
        }

        /// <summary>
        /// Marks the map as an ID map. Use this for primary keys that do not auto increment
        /// </summary>
        /// <returns></returns>
        public PropertyMapBuilder AsPrimaryKey() {
            IsPrimaryKey = true;
            return this;
        }

        /// <summary>
        /// Marks the map as an ID map. Use this for primary keys that do not auto increment
        /// </summary>
        /// <returns></returns>
        [Obsolete("Use AsPrimaryKey instead")]
        public PropertyMapBuilder AsID() {
            IsPrimaryKey = true;
            return this;
        }

        /// <summary>
        /// Marks the map as a Fileman date map. Only use this on Intersystems Caché/Iris databases.
        /// </summary>
        /// <returns></returns>
        public PropertyMapBuilder AsFilemanDateMap() {
            IsFilemanDateMap = true;
            return this;
        }

        /// <summary>
        /// Marks the map as a $HOROLOG date map. Only use this on Intersystems Caché/Iris databases
        /// </summary>
        /// <returns></returns>
        public PropertyMapBuilder AsHorologDateMap() {
            IsHorologDateMap = true;
            return this;
        }

        /// <summary>
        /// Currently only used by Cache and Iris databases.
        /// Typical options are %INTERNAL and %EXTERNAL.
        /// </summary>
        /// <param name="functionName">Name of the function that will be used to display the column. </param>
        /// <returns></returns>
        public PropertyMapBuilder UsingFunction(string functionName) {
            FunctionName = functionName;
            return this;
        }

        private IMap GetReturnMap(string columnName = null) {
            if (IsAutonumber)
                return new AutonumberMap(PropertyName, columnName ?? PropertyName, FunctionName);
            else if (IsPrimaryKey)
                return new IDMap(PropertyName, columnName ?? PropertyName, FunctionName);
            else if (IsFilemanDateMap)
                return new CacheFilemanDateMap(PropertyName, columnName ?? PropertyName, FunctionName);
            else if (IsHorologDateMap)
                return new CacheHorologDateMap(PropertyName, columnName ?? PropertyName, FunctionName);
            return new Map(PropertyName, columnName ?? PropertyName, FunctionName);
        }

        /// <summary>
        /// 
        /// </summary>
        /// <returns></returns>
        public override int GetHashCode() {
            return PropertyName.ToLower().GetHashCode();
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="other"></param>
        /// <returns></returns>
        public bool Equals(PropertyMapBuilder other) {
            return other != null && PropertyName.Equals(other.PropertyName, StringComparison.InvariantCultureIgnoreCase);
        }
    }
}
